<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WSA Seminovos — Catálogo</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <style>
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }
        /* Aplica o fundo preto sólido e cor de texto base */
        body {
            @apply bg-black text-gray-200 min-h-screen;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        function main() {
            const { useEffect, useMemo, useState, useRef } = React;
            
            // =============================
            // UTILITÁRIOS
            // =============================
            const real = (n) => typeof n === 'number' ? n.toLocaleString("pt-BR", { style: "currency", currency: "BRL" }) : real(0);
            const km = (n) => typeof n === 'number' ? `${n.toLocaleString("pt-BR")} km` : km(0);
            const ucFirst = (s) => s ? s.charAt(0).toUpperCase() + s.slice(1) : s;
            const slugify = (s) => s ? s.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/(^-|-$)/g, "") : "";
            const brLocaleDate = (d) => d ? new Intl.DateTimeFormat("pt-BR", { dateStyle: "medium" }).format(d) : "";
            const generateSlug = (v) => v ? `${slugify(`${v.brand} ${v.model} ${v.version}`)}-${v.id}` : "";

            // =============================
            // DADOS PARA UPLOAD INICIAL (Seed)
            // =============================
            const MOCK_VEHICLES_FOR_SEEDING = [
              {
                id: 254929, brand: "Fiat", model: "Cronos", version: "Drive 1.0", yearFab: 2023, yearModel: 2024, fuel: "Flex", transmission: "Manual", engine: "1.0", body: "Sedan", color: "Prata", plateFinal: "6", doors: 4, km: 46698, city: "Ananindeua", state: "PA", priceBase: 84090, price: 75990, tags: ["Mais pesquisado", "Foto 360º"],
                photos: ["https://placehold.co/960x640/222/FFF?text=Fiat+Cronos+1", "https://placehold.co/960x640/222/FFF?text=Fiat+Cronos+2", "https://placehold.co/960x640/222/FFF?text=Fiat+Cronos+3", "https://placehold.co/960x640/222/FFF?text=Fiat+Cronos+4"],
                store: { name: "Loja Ananindeua/PA", phone: "0800 200 2000", address: "Rua MÁRIO COVAS, 545 - Ananindeua / PA", hours: [{ d: "Segunda à sexta", h: "08:00 - 19:00" }, { d: "Sábado", h: "08:00 - 18:00" }, { d: "Domingo", h: "09:00 - 16:00" }], },
              },
              {
                id: 202401, brand: "Hyundai", model: "HB20", version: "Sense Plus 1.0", yearFab: 2023, yearModel: 2024, fuel: "Flex", transmission: "Manual", engine: "1.0", body: "Hatch", color: "Branco", plateFinal: "3", doors: 4, km: 41104, city: "São Paulo", state: "SP", priceBase: 71290, price: 67990, tags: ["Mais pesquisado"],
                photos: ["https://placehold.co/960x640/222/FFF?text=Hyundai+HB20+1", "https://placehold.co/960x640/222/FFF?text=Hyundai+HB20+2"],
                store: { name: "Loja São Paulo/SP", phone: "0800 200 2000", address: "Av. Exemplo, 123 - São Paulo / SP", hours: [{d:"Seg-Sex", h:"09-18"}, {d:"Sáb", h:"09-13"}] },
              },
              {
                id: 202402, brand: "Volkswagen", model: "Polo", version: "1.0", yearFab: 2023, yearModel: 2024, fuel: "Flex", transmission: "Manual", engine: "1.0", body: "Hatch", color: "Cinza", plateFinal: "8", doors: 4, km: 45806, city: "São Paulo", state: "SP", priceBase: 77390, price: 72990, tags: ["Mais pesquisado", "Foto 360º"],
                photos: ["https://placehold.co/960x640/222/FFF?text=Volkswagen+Polo+1"],
                store: { name: "Loja São Paulo/SP", phone: "0800 200 2000", address: "Av. Exemplo, 123 - São Paulo / SP", hours: [{d:"Seg-Sex", h:"09-18"}, {d:"Sáb", h:"09-13"}] },
              },
              {
                id: 202403, brand: "Jeep", model: "Renegade", version: "Longitude 1.3", yearFab: 2023, yearModel: 2024, fuel: "Flex", transmission: "Automático", engine: "1.3", body: "SUV", color: "Preto", plateFinal: "4", doors: 4, km: 45500, city: "Curitiba", state: "PR", priceBase: 125190, price: 111990, tags: ["Mais pesquisado", "Foto 360º"],
                photos: ["https://placehold.co/960x640/222/FFF?text=Jeep+Renegade+1"],
                store: { name: "Loja Curitiba/PR", phone: "0800 200 2000", address: "Rua Exemplo, 456 - Curitiba / PR", hours: [{d:"Seg-Sex", h:"08-18"}] },
              },
              {
                id: 202404, brand: "Chevrolet", model: "Onix Plus", version: "LTZ 1.0", yearFab: 2023, yearModel: 2024, fuel: "Flex", transmission: "Automático", engine: "1.0", body: "Sedan", color: "Azul", plateFinal: "1", doors: 4, km: 53617, city: "Ananindeua", state: "GO",
                priceBase: 90090, price: 85490, tags: ["Foto 360º"],
                photos: ["https://placehold.co/960x640/222/FFF?text=Chevrolet+Onix+Plus+1"],
                store: { name: "Loja Ananindeua/GO", phone: "0800 200 2000", address: "Av. Central, 100 - Ananindeua / GO", hours: [{d:"Seg-Sáb", h:"08-18"}] },
              },
              {
                id: 202405, brand: "Renault", model: "Kwid", version: "1.0", yearFab: 2022, yearModel: 2023, fuel: "Flex", transmission: "Manual", engine: "1.0", body: "Hatch", color: "Vermelho", plateFinal: "5", doors: 4, km: 38200, city: "Belo Horizonte", state: "MG", priceBase: 57990, price: 51990, tags: [],
                photos: ["https://placehold.co/960x640/222/FFF?text=Renault+Kwid+1"],
                store: { name: "Loja BH/MG", phone: "0800 200 2000", address: "Rua X, 10 - Belo Horizonte / MG", hours: [{d:"Seg-Sex", h:"08:30-18"}] },
              },
              {
                id: 202406, brand: "Volkswagen", model: "T-Cross", version: "Comfortline 1.0", yearFab: 2023, yearModel: 2024, fuel: "Flex", transmission: "Automático", engine: "1.0", body: "SUV", color: "Branco", plateFinal: "7", doors: 4, km: 43300, city: "Joinville", state: "SC", priceBase: 124390, price: 117990, tags: [],
                photos: ["https://placehold.co/960x640/222/FFF?text=Volkswagen+T-Cross+1"],
                store: { name: "Loja Joinville/SC", phone: "0800 200 2000", address: "Av. XPTO, 200 - Joinville / SC", hours: [{d:"Seg-Sex", h:"08-18"}, {d:"Sáb", h:"08-12"}] },
              },
              {
                id: 202407, brand: "Nissan", model: "Kicks", version: "Advance 1.6", yearFab: 2023, yearModel: 2024, fuel: "Flex", transmission: "Automático", engine: "1.6", body: "SUV", color: "Prata", plateFinal: "2", doors: 4, km: 40120, city: "Rio de Janeiro", state: "RJ", priceBase: 112990, price: 108990, tags: [],
                photos: ["https://placehold.co/960x640/222/FFF?text=Nissan+Kicks+1"],
                store: { name: "Loja Rio/RJ", phone: "0800 200 2000", address: "Av. Atlântica, 500 - Rio de Janeiro / RJ", hours: [{d:"Seg-Sex", h:"09-19"}] },
              },
              {
                id: 202408, brand: "Fiat", model: "Argo", version: "Drive 1.0", yearFab: 2023, yearModel: 2024, fuel: "Flex", transmission: "Manual", engine: "1.0", body: "Hatch", color: "Prata", plateFinal: "9", doors: 4, km: 41955, city: "Ananindeua", state: "GO",
                priceBase: 72890, price: 69990, tags: ["Mais pesquisado"],
                photos: ["https://placehold.co/960x640/222/FFF?text=Fiat+Argo+1"],
                store: { name: "Loja Ananindeua/GO", phone: "0800 200 2000", address: "Av. Central, 100 - Ananindeua / GO", hours: [{d:"Seg-Sáb", h:"08-18"}] },
              },
              {
                id: 202409, brand: "Toyota", model: "Corolla", version: "GLi 2.0", yearFab: 2022, yearModel: 2023, fuel: "Flex", transmission: "Automático", engine: "2.0", body: "Sedan", color: "Preto", plateFinal: "0", doors: 4, km: 49200, city: "Brasília", state: "DF", priceBase: 119990, price: 114990, tags: [],
                photos: ["https://placehold.co/960x640/222/FFF?text=Toyota+Corolla+1"],
                store: { name: "Loja Brasília/DF", phone: "0800 200 2000", address: "SQN 100 - Brasília / DF", hours: [{d:"Seg-Sex", h:"09-18"}, {d:"Sáb", h:"09-13"}] },
              },
              {
                id: 202410, brand: "Chevrolet", model: "Onix", version: "LT 1.0", yearFab: 2023, yearModel: 2024, fuel: "Flex", transmission: "Manual", engine: "1.0", body: "Hatch", color: "Branco", plateFinal: "1", doors: 4, km: 44768, city: "Rio de Janeiro", state: "RJ", priceBase: 71390, price: 69990, tags: ["Mais pesquisado", "Foto 360º"],
                photos: ["https://placehold.co/960x640/222/FFF?text=Chevrolet+Onix+1"],
                store: { name: "Loja Rio/RJ", phone: "0800 200 2000", address: "Av. Atlântica, 500 - Rio de Janeiro / RJ", hours: [{d:"Seg-Sex", h:"09-19"}] },
              },
            ];
            MOCK_VEHICLES_FOR_SEEDING.forEach(v => { v.slug = generateSlug(v); });
            const ACCESSORIES = [
              "Alarme", "Ar-condicionado", "Banco do motorista com ajuste de altura", "Computador de bordo",
              "Desembaçador traseiro", "Direção elétrica", "Distribuição eletrônica de frenagem", "Freio ABS",
              "Sensor de estacionamento", "Travas elétricas", "Volante com regulagem de altura",
            ];

            // =============================
            // COMPONENTES BÁSICOS
            // =============================
            function LoadingScreen({ message = "Carregando..." }) {
                return (
                    <div className="flex items-center justify-center h-screen w-full text-gray-400 text-xl bg-black">
                        {message}
                    </div>
                );
            }

            function Icon({ name, className = "w-5 h-5" }) {
              const icons = {
                menu: ( <svg viewBox="0 0 24 24" fill="currentColor" className={className} aria-hidden="true"> <path d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h18v2H3v-2z"/> </svg> ),
                heart: ( <svg viewBox="0 0 24 24" fill="currentColor" className={className} aria-hidden="true"> <path d="M12 21s-6.716-4.53-9.33-7.144A5.25 5.25 0 1 1 12 6.337a5.25 5.25 0 1 1 9.33 7.52C18.716 16.47 12 21 12 21z"/> </svg> ),
                star: ( <svg viewBox="0 0 24 24" fill="currentColor" className={className} aria-hidden="true"> <path d="M12 .587l3.668 7.431 8.2 1.19-5.934 5.787 1.402 8.167L12 18.897 4.664 23.162l1.402-8.167L.132 9.208l8.2-1.19z"/> </svg> ),
                lightning: ( <svg viewBox="0 0 24 24" fill="currentColor" className={className} aria-hidden="true"> <path d="M13 2L3 14h7l-1 8 10-12h-7l1-8z"/> </svg> ),
                map: ( <svg viewBox="0 0 24 24" fill="currentColor" className={className} aria-hidden="true"> <path d="M9.5 3l5 2 5-2v18l-5 2-5-2-5 2V5l5-2zm0 2.236L6 6.118v13.646l3.5-1.4V5.236zm2 0v13.128l3 1.2V6.436l-3-1.2zM19 4.382l-2.5.999v13.647L19 18.03V4.382z"/> </svg> ),
                phone: ( <svg viewBox="0 0 24 24" fill="currentColor" className={className} aria-hidden="true"> <path d="M6.62 10.79a15.054 15.054 0 006.59 6.59l2.2-2.2a1 1 0 011.05-.24c1.15.38 2.39.58 3.64.58a1 1 0 011 1v3.5a1 1 0 01-1 1C10.07 22 2 13.93 2 4a1 1 0 011-1h3.5a1 1 0 011 1c0 1.25.2 2.49.58 3.64a1 1 0 01-.24 1.05l-2.22 2.1z"/> </svg> ),
                filter: ( <svg viewBox="0 0 24 24" fill="currentColor" className={className} aria-hidden="true"> <path d="M3 5h18v2H3V5zm4 6h10v2H7v-2zm-2 6h14v2H5v-2z"/> </svg> ),
                x: ( <svg viewBox="0 0 24 24" fill="currentColor" className={className} aria-hidden="true"> <path d="M18.3 5.71a1 1 0 00-1.41 0L12 10.59 7.11 5.7A1 1 0 105.7 7.11L10.59 12l-4.9 4.89a1 1 0 101.41 1.41L12 13.41l4.89 4.9a1 1 0 001.41-1.41L13.41 12l4.9-4.89a1 1 0 000-1.4z"/> </svg> ),
                chevronRight: ( <svg viewBox="0 0 24 24" fill="currentColor" className={className} aria-hidden="true"> <path d="M9 6l6 6-6 6"/> </svg> ),
                chevronLeft: ( <svg viewBox="0 0 24 24" fill="currentColor" className={className} aria-hidden="true"> <path d="M15 6l-6 6 6 6"/> </svg> ),
                search: ( <svg viewBox="0 0 24 24" fill="currentColor" className={className} aria-hidden="true"> <path d="M10 2a8 8 0 015.292 13.708l4 4a1 1 0 01-1.414 1.414l-4-4A8 8 0 1110 2zm0 2a6 6 0 100 12A6 6 0 0010 4z"/> </svg> ),
              };
              return icons[name] ?? null;
            }

            function Badge({ children, className = "" }) {
              return (
                <span className={`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium bg-gray-700 text-gray-200 ${className}`}>
                  {children}
                </span>
              );
            }

            function Button({ children, onClick, className = "", type = "button", ariaLabel, disabled = false }) {
              const baseStyle = "bg-gray-800 text-white hover:bg-gray-700 ring-gray-700";
              return (
                <button
                  type={type}
                  aria-label={ariaLabel}
                  onClick={onClick}
                  disabled={disabled}
                  className={`inline-flex items-center justify-center rounded-xl px-4 py-2 text-sm font-semibold shadow-sm ring-1 active:scale-[.99] transition ${baseStyle} ${className} ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`}
                >
                  {children}
                </button>
              );
            }

            function Field({ label, children }) {
              return (
                <label className="grid gap-1 text-sm">
                  <span className="text-gray-400">{label}</span>
                  {children}
                </label>
              );
            }

            // =============================
            // CABEÇALHO/RODAPÉ
            // =============================
            function TopBar() {
              return (
                <div className="w-full bg-red-600 text-white text-xs">
                  <div className="mx-auto max-w-7xl flex items-center justify-between px-3 py-2">
                    <div className="flex items-center gap-2"><Icon name="phone" className="w-4 h-4"/> Central de vendas: <a href="tel:08002002000" className="underline">0800-200-2000</a></div>
                    <div className="hidden sm:block">Atendimento: seg–sex 08:00–19:00 · sáb 08:00–18:00 · dom/feriados 09:00–16:00</div>
                  </div>
                </div>
              );
            }

            function Header({ onSearch, initialQuery = "", user, onSignOut }) {
              const [q, setQ] = useState(initialQuery);
              const [isMenuOpen, setIsMenuOpen] = useState(false);
              const isLoggedIn = user && user.profile && user.profile.role !== 'visitor';
              const isAdmin = user && user.profile && user.profile.role === 'admin';

              return (
                <header className="sticky top-0 z-40 backdrop-blur bg-black/80 border-b border-gray-800">
                  <div className="mx-auto max-w-7xl px-3">
                    <div className="flex items-center justify-between py-3 gap-3">
                      <a href="#/" className="flex items-center gap-2 font-bold text-xl text-white">
                        <span className="inline-block w-6 h-6 bg-red-600 rounded"></span>
                        <span>WSA Seminovos</span>
                      </a>
                      <div className="flex-1 max-w-2xl">
                        <div className="relative">
                          <input
                            aria-label="Buscar por marca, modelo, versão"
                            value={q}
                            onChange={(e) => setQ(e.target.value)}
                            onKeyDown={(e) => e.key === "Enter" && onSearch(q)}
                            placeholder="Busque por marca, modelo, versão…"
                            className="w-full rounded-xl border border-gray-700 bg-gray-900 text-white px-4 py-2.5 pr-10 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 placeholder-gray-500"
                          />
                          <button onClick={() => onSearch(q)} aria-label="Buscar" className="absolute right-2 top-1/2 -translate-y-1/2 p-1 rounded-md text-gray-400 hover:bg-gray-800">
                            <Icon name="search" />
                          </button>
                        </div>
                      </div>
                      <nav className="hidden md:flex items-center gap-4 text-sm">
                        <a href="#/estoque" className="text-gray-300 hover:text-red-500">Estoque</a>
                        <a href="#/lojas" className="text-gray-300 hover:text-red-500">Lojas</a>
                        <a href="#/duvidas" className="text-gray-300 hover:text-red-500">Dúvidas</a>
                        {isAdmin && <a href="#/admin" className="text-yellow-400 hover:text-yellow-300">Admin</a>}
                        {isLoggedIn ? (
                           <button onClick={onSignOut} className="text-gray-300 hover:text-red-500">Sair</button>
                        ) : (
                           <a href="#/login" className="text-gray-300 hover:text-red-500">Entrar / Cadastrar</a>
                        )}
                        <a href="https://wa.me/5511000000000" target="_blank" rel="noreferrer" className="rounded-lg bg-red-600 text-white px-3 py-1.5 hover:bg-red-700">Falar no WhatsApp</a>
                      </nav>
                      <div className="md:hidden">
                        <button
                          onClick={() => setIsMenuOpen(!isMenuOpen)}
                          className="p-2 rounded-md text-gray-300 hover:bg-gray-800"
                          aria-label="Abrir menu"
                          aria-expanded={isMenuOpen}
                        >
                          {isMenuOpen ? <Icon name="x" /> : <Icon name="menu" />}
                        </button>
                      </div>
                    </div>

                    {isMenuOpen && (
                      <div className="md:hidden absolute top-full left-0 right-0 bg-black border-b border-gray-700 shadow-lg z-50 p-4">
                        <nav className="flex flex-col gap-4 text-sm">
                          <a href="#/estoque" className="text-gray-300 hover:text-red-500 p-2 rounded-md hover:bg-gray-800" onClick={() => setIsMenuOpen(false)}>Estoque</a>
                          <a href="#/lojas" className="text-gray-300 hover:text-red-500 p-2 rounded-md hover:bg-gray-800" onClick={() => setIsMenuOpen(false)}>Lojas</a>
                          <a href="#/duvidas" className="text-gray-300 hover:text-red-500 p-2 rounded-md hover:bg-gray-800" onClick={() => setIsMenuOpen(false)}>Dúvidas</a>
                          {isAdmin && <a href="#/admin" className="text-yellow-400 hover:text-yellow-300 p-2 rounded-md hover:bg-gray-800" onClick={() => setIsMenuOpen(false)}>Admin</a>}
                          {isLoggedIn ? (
                            <button
                                onClick={() => { onSignOut(); setIsMenuOpen(false); }}
                                className="text-left text-gray-300 hover:text-red-500 p-2 rounded-md hover:bg-gray-800"
                            >
                                Sair
                            </button>
                          ) : (
                            <a href="#/login" className="text-gray-300 hover:text-red-500 p-2 rounded-md hover:bg-gray-800" onClick={() => setIsMenuOpen(false)}>Entrar / Cadastrar</a>
                          )}
                          <a href="https://wa.me/5511000000000" target="_blank" rel="noreferrer" className="rounded-lg bg-red-600 text-white px-3 py-2 text-center hover:bg-red-700" onClick={() => setIsMenuOpen(false)}>Falar no WhatsApp</a>
                        </nav>
                      </div>
                    )}
                  </div>
                </header>
              );
            }

            function Footer() {
              return (
                <footer className="bg-black border-t border-gray-800 mt-16">
                  <div className="mx-auto max-w-7xl px-3 py-10 grid md:grid-cols-4 gap-8 text-sm">
                    <div>
                      <div className="font-semibold mb-2 text-white">WSA Seminovos</div>
                      <p className="text-gray-400">Catálogo digital de seminovos com baixa quilometragem, garantia e financiamento rápido.</p>
                    </div>
                    <div>
                      <div className="font-semibold mb-2 text-white">Institucional</div>
                      <ul className="space-y-1 text-gray-400">
                        <li><a href="#/vantagens" className="hover:text-red-500">Vantagens e benefícios</a></li>
                        <li><a href="#/lojas" className="hover:text-red-500">Nossas lojas</a></li>
                        <li><a href="#/duvidas" className="hover:text-red-500">Dúvidas</a></li>
                      </ul>
                    </div>
                    <div>
                      <div className="font-semibold mb-2 text-white">Atendimento</div>
                      <ul className="space-y-1 text-gray-400">
                        <li>Central de vendas: <a className="underline" href="tel:08002002000">0800-200-2000</a></li>
                        <li>WhatsApp: <a className="underline" href="https://wa.me/5500000000000" target="_blank" rel="noreferrer">(00) 00000-0000</a></li>
                      </ul>
                    </div>
                    <div>
                      <div className="font-semibold mb-2 text-white">Legal</div>
                      <ul className="space-y-1 text-gray-400">
                        <li><a href="#/termos" className="hover:text-red-500">Termos de uso</a></li>
                        <li><a href="#/privacidade" className="hover:text-red-500">Privacidade</a></li>
                        <li>© {new Date().getFullYear()} WSA. Todos os direitos reservados.</li>
                      </ul>
                    </div>
                  </div>
                </footer>
              );
            }

            // =============================
            // FILTROS / ESTADO
            // =============================
            function useCatalog(initialVehicles) {
              const [query, setQuery] = useState("");
              const [filters, setFilters] = useState({ brand: "", model: "", state: "", body: "", fuel: "", transmission: "", priceMin: 0, priceMax: 200000, yearMin: 2019, yearMax: 2025, kmMax: 100000, });
              const [sort, setSort] = useState("relevance");
              const [page, setPage] = useState(1);
              const pageSize = 9;

              const uniqueOptions = useMemo(() => {
                const brands = [...new Set(initialVehicles.map(v => v.brand))].sort();
                const modelsByBrand = {};
                for (const v of initialVehicles) { modelsByBrand[v.brand] = modelsByBrand[v.brand] || []; if (!modelsByBrand[v.brand].includes(v.model)) modelsByBrand[v.brand].push(v.model); }
                for (const k in modelsByBrand) modelsByBrand[k].sort();
                const allModels = [...new Set(initialVehicles.map(v => v.model))].sort();
                const states = [...new Set(initialVehicles.map(v => v.state))].sort();
                const bodies = [...new Set(initialVehicles.map(v => v.body))].sort();
                const fuels = [...new Set(initialVehicles.map(v => v.fuel))].sort();
                const transmissions = [...new Set(initialVehicles.map(v => v.transmission))].sort();
                return { brands, modelsByBrand, allModels, states, bodies, fuels, transmissions };
              }, [initialVehicles]);

              const filtered = useMemo(() => {
                const q = query.trim().toLowerCase();
                let list = initialVehicles.filter((v) => {
                  const inQuery = !q || `${v.brand} ${v.model} ${v.version}`.toLowerCase().includes(q);
                  const priceOK = v.price >= filters.priceMin && v.price <= filters.priceMax;
                  const yearOK = v.yearModel >= filters.yearMin && v.yearModel <= filters.yearMax;
                  const kmOK = v.km <= filters.kmMax;
                  const brandOK = !filters.brand || v.brand === filters.brand;
                  const modelOK = !filters.model || v.model === filters.model;
                  const stateOK = !filters.state || v.state === filters.state;
                  const bodyOK = !filters.body || v.body === filters.body;
                  const fuelOK = !filters.fuel || v.fuel === filters.fuel;
                  const transOK = !filters.transmission || v.transmission === filters.transmission;
                  return inQuery && priceOK && yearOK && kmOK && brandOK && modelOK && stateOK && bodyOK && fuelOK && transOK;
                });
                switch (sort) {
                  case "price-asc": list = list.sort((a, b) => a.price - b.price); break;
                  case "price-desc": list = list.sort((a, b) => b.price - a.price); break;
                  case "km-asc": list = list.sort((a, b) => a.km - b.km); break;
                  case "year-desc": list = list.sort((a, b) => b.yearModel - a.yearModel); break;
                  default: list = list.sort((a, b) => (b.tags?.includes("Mais pesquisado") ? 1 : 0) - (a.tags?.includes("Mais pesquisado") ? 1 : 0));
                }
                return list;
              }, [initialVehicles, query, filters, sort]);

              const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
              const paginated = filtered.slice((page - 1) * pageSize, page * pageSize);

              useEffect(() => { setPage(1); }, [query, JSON.stringify(filters)]);

              return { query, setQuery, filters, setFilters, sort, setSort, page, setPage, pageSize, totalPages, list: paginated, fullList: filtered, uniqueOptions };
            }

            // =============================
            // COMPONENTES DE PÁGINA
            // =============================
            function Home({ vehicles }) {
              return (
                <main>
                  <section className="bg-gradient-to-b from-gray-950 to-black">
                    <div className="mx-auto max-w-7xl px-3 py-12 grid md:grid-cols-2 gap-10 items-center">
                      <div>
                        <h1 className="text-3xl md:text-5xl font-extrabold leading-tight tracking-tight text-white">Seu seminovo ideal, com transparência e financiamento rápido.</h1>
                        <p className="mt-4 text-gray-400 max-w-prose">Explore nosso estoque com filtros avançados, fotos em alta resolução e simulação de financiamento 100% digital. Agende uma visita e faça um test drive.</p>
                        <div className="mt-6 flex gap-3">
                          <a href="#/estoque" className="rounded-2xl bg-red-600 text-white px-5 py-3 font-semibold shadow-sm hover:bg-red-700">Ver estoque</a>
                          <a href="#/duvidas" className="rounded-2xl bg-gray-900 text-white ring-1 ring-gray-700 hover:bg-gray-800 px-5 py-3 font-semibold shadow-sm">Tirar dúvidas</a>
                        </div>
                        <ul className="mt-8 grid sm:grid-cols-3 gap-3 text-sm text-gray-300">
                          <li className="flex items-center gap-2"><Icon name="star" className="w-4 h-4 text-red-600"/> Garantia 3 a 12 meses</li>
                          <li className="flex items-center gap-2"><Icon name="lightning" className="w-4 h-4 text-red-600"/> Aprovação rápida</li>
                          <li className="flex items-center gap-2"><Icon name="map" className="w-4 h-4 text-red-600"/> Lojas próximas</li>
                        </ul>
                      </div>
                      <div className="aspect-video rounded-3xl overflow-hidden shadow-xl">
                        <img src="https://placehold.co/1200x700/111/FFF?text=WSA+Veiculos" alt="Seminovos em destaque" className="w-full h-full object-cover" loading="lazy"/>
                      </div>
                    </div>
                  </section>
                  <section className="mx-auto max-w-7xl px-3 py-12">
                    <h2 className="text-xl font-bold mb-4 text-white">Destaques do estoque</h2>
                    <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
                      {vehicles.slice(0, 6).map((v) => <VehicleCard key={v.id} v={v} />)}
                    </div>
                    <div className="mt-6"><a className="inline-block rounded-xl bg-gray-200 text-black hover:bg-white px-4 py-2" href="#/estoque">Ver todos ({vehicles.length})</a></div>
                  </section>
                </main>
              );
            }

            function Filters({ state, setState, uniqueOptions }) {
              const { brands, modelsByBrand, allModels, states, bodies, fuels, transmissions } = uniqueOptions;
              return (
                <aside className="grid gap-4 p-4 rounded-2xl ring-1 ring-gray-800 bg-gray-900 lg:bg-transparent lg:p-0 lg:ring-0">
                  <div className="flex items-center gap-2 text-sm font-semibold text-gray-300"><Icon name="filter"/> Filtros</div>
                  <Field label="Marca"><select className="input-admin" value={state.brand} onChange={(e)=> setState(s=>({...s, brand: e.target.value, model: ""}))}><option value="">Todas</option>{brands.map(b => <option key={b} value={b}>{b}</option>)}</select></Field>
                  <Field label="Modelo"><select className="input-admin" value={state.model} onChange={(e)=> setState(s=>({...s, model: e.target.value}))}><option value="">Todos</option>{(state.brand ? (modelsByBrand[state.brand] || []) : allModels).map(m => <option key={m} value={m}>{m}</option>)}</select></Field>
                  <Field label="Estado"><select className="input-admin" value={state.state} onChange={(e)=> setState(s=>({...s, state: e.target.value}))}><option value="">Todos</option>{states.map(uf => <option key={uf} value={uf}>{uf}</option>)}</select></Field>
                  <Field label="Carroceria"><select className="input-admin" value={state.body} onChange={(e)=> setState(s=>({...s, body: e.target.value}))}><option value="">Todas</option>{bodies.map(b => <option key={b} value={b}>{b}</option>)}</select></Field>
                  <Field label="Combustível"><select className="input-admin" value={state.fuel} onChange={(e)=> setState(s=>({...s, fuel: e.target.value}))}><option value="">Todos</option>{fuels.map(f => <option key={f} value={f}>{f}</option>)}</select></Field>
                  <Field label="Câmbio"><select className="input-admin" value={state.transmission} onChange={(e)=> setState(s=>({...s, transmission: e.target.value}))}><option value="">Todos</option>{transmissions.map(t => <option key={t} value={t}>{t}</option>)}</select></Field>
                  <Field label={`Preço (${real(state.priceMin)} – ${real(state.priceMax)})`}> <div className="grid grid-cols-2 gap-2"><input type="number" min={0} max={state.priceMax} className="input-admin" value={state.priceMin} onChange={(e)=> setState(s=>({...s, priceMin: Number(e.target.value||0)}))}/><input type="number" min={state.priceMin} className="input-admin" value={state.priceMax} onChange={(e)=> setState(s=>({...s, priceMax: Number(e.target.value||0)}))}/></div> </Field>
                  <Field label={`Ano modelo (${state.yearMin}–${state.yearMax})`}> <div className="grid grid-cols-2 gap-2"><input type="number" min={2015} max={state.yearMax} className="input-admin" value={state.yearMin} onChange={(e)=> setState(s=>({...s, yearMin: Number(e.target.value||0)}))}/><input type="number" min={state.yearMin} max={2026} className="input-admin" value={state.yearMax} onChange={(e)=> setState(s=>({...s, yearMax: Number(e.target.value||0)}))}/></div> </Field>
                  <Field label={`Quilometragem máxima (${km(state.kmMax)})`}> <input type="range" min={10000} max={120000} step={1000} value={state.kmMax} className="accent-red-600 w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer" onChange={(e)=> setState(s=>({...s, kmMax: Number(e.target.value)}))}/> </Field>
                  <Button className="bg-gray-200 text-black hover:bg-white" onClick={()=> setState({ brand:"", model:"", state:"", body:"", fuel:"", transmission:"", priceMin:0, priceMax:200000, yearMin:2019, yearMax:2025, kmMax:100000 })}>Limpar filtros</Button>
                </aside>
              );
            }

            function Toolbar({ total, sort, setSort, query, setQuery, onShowFilters }) {
              return (
                <div className="flex flex-wrap items-center justify-between gap-3">
                  <div className="text-sm text-gray-400">{total} veículos</div>
                  <div className="flex items-center gap-2">
                    <Button className="lg:hidden bg-gray-800 text-white hover:bg-gray-700 ring-gray-700" onClick={onShowFilters}> <Icon name="filter" className="w-4 h-4 mr-1"/> Filtrar </Button>
                    <input aria-label="Buscar no estoque" value={query} onChange={(e)=> setQuery(e.target.value)} placeholder="Buscar no estoque" className="input-admin !py-2" />
                    <select value={sort} onChange={(e)=> setSort(e.target.value)} className="input-admin !py-2"><option value="relevance">Mais relevantes</option><option value="price-asc">Menor preço</option><option value="price-desc">Maior preço</option><option value="km-asc">Menor km</option><option value="year-desc">Mais novos</option></select>
                  </div>
                </div>
              );
            }

            function VehicleCard({ v }) {
              const href = `#/carro/${v.slug}`;
              return (
                <a href={href} className="group rounded-2xl ring-1 ring-gray-800 bg-gray-900 overflow-hidden hover:bg-gray-800 transition">
                  <div className="relative aspect-[4/3] overflow-hidden bg-gray-800">
                    <img src={v.photos?.[0]} alt={`${v.brand} ${v.model}`} className="w-full h-full object-cover group-hover:scale-[1.02] transition" loading="lazy" onError={(e) => e.target.src = 'https://placehold.co/960x640/222/FFF?text=Foto+Indisponivel'} />
                    <div className="absolute top-2 left-2 flex gap-2">
                      {v.tags?.slice(0,2).map((t)=> <Badge key={t} className="bg-black/80 backdrop-blur text-gray-200 ring-1 ring-gray-700">{t}</Badge>)}
                    </div>
                  </div>
                  <div className="p-4 grid gap-2">
                    <div className="flex items-center justify-between">
                      <div className="font-semibold text-white">{v.brand}</div>
                      <Badge className="bg-red-950 text-red-300 ring-1 ring-red-800">{v.yearFab}/{v.yearModel}</Badge>
                    </div>
                    <div className="text-white text-lg font-bold leading-snug">{v.model} {v.version}</div>
                    <div className="text-sm text-gray-400">{km(v.km)} · {v.transmission} · {v.fuel}</div>
                    <div className="text-xs text-gray-400 flex items-center gap-1"><Icon name="map" className="w-4 h-4"/> {v.city}/{v.state}</div>
                    <div className="mt-2">
                      {v.priceBase > v.price && ( <div className="text-xs text-gray-500 line-through">{real(v.priceBase)}</div> )}
                      <div className="text-xl font-extrabold text-white">{real(v.price)}</div>
                    </div>
                  </div>
                </a>
              );
            }

            function Pagination({ page, setPage, totalPages }) {
              if (totalPages <= 1) return null;
              const pagesToShow = 5;
              let startPage = Math.max(1, page - Math.floor(pagesToShow / 2));
              let endPage = Math.min(totalPages, startPage + pagesToShow - 1);
              if (endPage - startPage + 1 < pagesToShow) { startPage = Math.max(1, endPage - pagesToShow + 1); }
              const pages = Array.from({ length: endPage - startPage + 1 }, (_, i) => startPage + i);

              return (
                 <div className="flex items-center justify-center gap-1 mt-6">
                  <Button className="bg-gray-800 text-white hover:bg-gray-700" onClick={()=> setPage(Math.max(1, page-1))} disabled={page === 1} aria-label="Página anterior"><Icon name="chevronLeft"/></Button>
                  {startPage > 1 && ( <> <Button className="bg-gray-800 text-gray-300 hover:bg-gray-700 ring-gray-700" onClick={()=> setPage(1)}>1</Button> {startPage > 2 && <span className="text-gray-500 px-1">...</span>} </> )}
                  {pages.map(p => (
                    <Button key={p} className={`ring-1 ring-gray-700 ${p === page ? "bg-red-600 text-white ring-red-600" : "bg-gray-800 text-gray-300 hover:bg-gray-700"}`} onClick={()=> setPage(p)}>{p}</Button>
                  ))}
                  {endPage < totalPages && ( <> {endPage < totalPages - 1 && <span className="text-gray-500 px-1">...</span>} <Button className="bg-gray-800 text-gray-300 hover:bg-gray-700 ring-gray-700" onClick={()=> setPage(totalPages)}>{totalPages}</Button> </> )}
                  <Button className="bg-gray-800 text-white hover:bg-gray-700" onClick={()=> setPage(Math.min(totalPages, page+1))} disabled={page === totalPages} aria-label="Próxima página"><Icon name="chevronRight"/></Button>
                </div>
              );
            }

            function Catalog({ vehicles }) {
              const { query, setQuery, filters, setFilters, sort, setSort, page, setPage, list, fullList, totalPages, uniqueOptions } = useCatalog(vehicles);
              const [showFilters, setShowFilters] = useState(false);
              useEffect(() => { document.title = `Estoque (${fullList.length}) — WSA Seminovos`; }, [fullList.length]);

              return (
                <main className="mx-auto max-w-7xl px-3 py-8">
                  <div className="grid lg:grid-cols-[280px_1fr] gap-6">
                    {showFilters && <div className="fixed inset-0 bg-black/50 z-40 lg:hidden" onClick={() => setShowFilters(false)}></div>}
                    <div className={`fixed lg:sticky top-0 lg:top-[4.5rem] self-start left-0 w-80 lg:w-auto h-full lg:h-auto bg-gray-900 lg:bg-transparent shadow-xl lg:shadow-none overflow-y-auto lg:overflow-visible z-50 lg:z-10 transform transition-transform ${showFilters ? 'translate-x-0' : '-translate-x-full'} lg:translate-x-0`}>
                      <div className="flex justify-between items-center p-4 lg:hidden">
                        <h3 className="font-semibold text-white">Filtros</h3>
                        <Button onClick={() => setShowFilters(false)} className="bg-gray-800 text-white !p-2">
                          <Icon name="x" className="w-4 h-4"/>
                        </Button>
                      </div>
                      <Filters state={filters} setState={setFilters} uniqueOptions={uniqueOptions} />
                    </div>
                    <section className="grid gap-4">
                      <Toolbar total={fullList.length} sort={sort} setSort={setSort} query={query} setQuery={setQuery} onShowFilters={() => setShowFilters(true)} />
                      {fullList.length === 0 ? (
                        <div className="p-12 text-center text-gray-400 ring-1 ring-gray-800 rounded-2xl">Nenhum veículo encontrado com os filtros atuais.</div>
                      ) : (
                        <> <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"> {list.map((v) => <VehicleCard key={v.id} v={v} />)} </div> <Pagination page={page} setPage={setPage} totalPages={totalPages}/> </>
                      )}
                    </section>
                  </div>
                </main>
              );
            }

            function FinanceSimulator({ price }) {
              const [entry, setEntry] = useState(Math.round(price * 0.2));
              const [months, setMonths] = useState(48);
              const [rate, setRate] = useState(1.79);
              const financed = Math.max(0, price - entry);
              const i = rate / 100;
              const pmt = financed > 0 && i > 0 ? (financed * i) / (1 - Math.pow(1 + i, -months)) : 0;
              return (
                <div className="grid gap-3 p-4 rounded-2xl ring-1 ring-gray-800 bg-gray-900">
                  <div className="font-semibold text-white">Simule um financiamento 100% digital</div>
                  <div className="grid sm:grid-cols-3 gap-3 text-sm">
                    <Field label="Entrada (R$)"><input type="number" className="input-admin" value={entry} onChange={(e)=> setEntry(Number(e.target.value||0))}/></Field>
                    <Field label="Parcelas (meses)"><input type="number" min={6} max={72} className="input-admin" value={months} onChange={(e)=> setMonths(Number(e.target.value||0))}/></Field>
                    <Field label="Taxa (% a.m.)"><input type="number" step="0.01" className="input-admin" value={rate} onChange={(e)=> setRate(Number(e.target.value||0))}/></Field>
                  </div>
                  <div className="text-sm text-gray-400">Valor financiado: <strong>{real(financed)}</strong></div>
                  <div className="text-2xl font-extrabold text-white">Parcela estimada: {real(pmt || 0)}</div>
                  <div className="text-xs text-gray-500">Simulação ilustrativa. Sujeito à aprovação de crédito.</div>
                  <div className="flex gap-3 mt-2">
                    <Button className="bg-red-600 text-white hover:bg-red-700">Quero simular</Button>
                    <Button className="bg-gray-800 text-white hover:bg-gray-700">Falar com consultor</Button>
                  </div>
                </div>
              );
            }
            function Specs({ v }) {
              const items = [ { label: "Quilometragem", value: km(v.km) }, { label: "Ano", value: `${v.yearFab}/${v.yearModel}` }, { label: "Combustível", value: v.fuel }, { label: "Câmbio", value: v.transmission }, { label: "Motor", value: v.engine }, { label: "Final de placa", value: v.plateFinal }, { label: "Portas", value: String(v.doors) }, { label: "Cor", value: v.color }, { label: "Carroceria", value: v.body }, ];
              return ( <div className="grid sm:grid-cols-3 gap-3"> {items.map((it) => ( <div key={it.label} className="rounded-xl ring-1 ring-gray-800 p-3 bg-gray-900"> <div className="text-xs text-gray-500">{it.label}</div> <div className="font-semibold text-white">{it.value || '-'}</div> </div> ))} </div> );
            }
            function Accessories() {
              return ( <div className="grid sm:grid-cols-2 md:grid-cols-3 gap-2"> {ACCESSORIES.map((a) => ( <div key={a} className="flex items-center gap-2 text-sm text-gray-300"> <span className="w-1.5 h-1.5 rounded-full bg-red-600"/> {a} </div> ))} </div> );
            }
            function StoreInfo({ v }) {
              return (
                <div className="grid gap-3 p-4 rounded-2xl ring-1 ring-gray-800 bg-gray-900">
                  <div className="font-semibold text-white">Conheça esse carro em nossa loja</div>
                  <div className="text-sm text-gray-300"><strong>Endereço: </strong>{v.store?.address || 'Não informado'}</div>
                  <div className="text-sm text-gray-300"><strong>Ligar: </strong><a className="underline" href={`tel:${v.store?.phone?.replace(/\D/g, "")}`}>{v.store?.phone || 'Não informado'}</a></div>
                  <div className="grid sm:grid-cols-2 gap-2 text-sm">
                    <div>
                      <div className="text-xs text-gray-500 mb-1">Horários de funcionamento</div>
                      <ul className="space-y-1 text-gray-300"> {(v.store?.hours?.length > 0 ? v.store.hours : []).map((h, index)=> ( <li key={index} className="flex justify-between"><span>{h.d}</span><span>{h.h}</span></li> ))} {v.store?.hours?.length === 0 && <li>Horário não informado</li>} </ul>
                      <div className="text-xs text-gray-500 mt-2">Recomendamos consultar horários em feriados.</div>
                    </div>
                    <div className="rounded-xl overflow-hidden ring-1 ring-gray-700 aspect-video bg-gray-800 flex items-center justify-center text-xs text-gray-500">Mapa (placeholder)</div>
                  </div>
                  <div className="flex gap-3"> <Button className="bg-gray-800 text-white hover:bg-gray-700">Agendar visita</Button> <Button className="bg-red-600 text-white hover:bg-red-700">Tenho interesse</Button> </div>
                </div>
              );
            }
            function Gallery({ photos }) {
              const [idx, setIdx] = useState(0);
              const currentPhotos = photos && photos.length > 0 ? photos : ['https://placehold.co/960x640/222/FFF?text=Sem+Fotos'];
              return (
                <div className="grid gap-3">
                  <div className="aspect-video rounded-2xl overflow-hidden ring-1 ring-gray-800 bg-black"> <img src={currentPhotos[idx]} alt="Foto do veículo" className="w-full h-full object-cover" onError={(e) => e.target.src = 'https://placehold.co/960x640/222/FFF?text=Erro+ao+Carregar'} /> </div>
                  <div className="flex gap-2 overflow-x-auto pb-2"> {currentPhotos.map((p, i) => ( <button key={i} onClick={()=> setIdx(i)} className={`h-20 aspect-video rounded-lg overflow-hidden ring-2 ring-offset-2 ring-offset-black transition ${i===idx?"ring-red-500":"ring-transparent hover:ring-gray-700"}`}> <img src={p} alt={`Foto ${i+1}`} className="w-full h-full object-cover" onError={(e) => e.target.src = 'https://placehold.co/160x90/222/FFF?text=Erro'} /> </button> ))} </div>
                </div>
              );
            }
            function Recommend({ currentId, vehicles }) {
              const recs = vehicles.filter(v => v.id !== currentId).slice(0, 3);
              if (recs.length === 0) return null;
              return ( <section className="mt-10"> <h3 className="text-lg font-bold mb-3 text-white">Você também pode gostar…</h3> <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"> {recs.map((v)=> <VehicleCard key={v.id} v={v} />)} </div> </section> );
            }
            function LoginPrompt({ slug, v }) {
               useEffect(() => { document.title = v ? `Login para ver ${v.brand} ${v.model} — WSA Seminovos` : "Login — WSA Seminovos"; window.scrollTo(0, 0); }, [v]);
              if (!v) return <LoadingScreen />;
              return ( <main className="mx-auto max-w-4xl px-3 py-10 text-center"> <div className="rounded-2xl ring-1 ring-gray-800 bg-gray-900 p-8"> <h1 className="text-2xl font-extrabold mb-4 text-white"> Acesse para ver todos os detalhes </h1> <p className="text-gray-400 mb-6 max-w-md mx-auto"> Para ver a galeria de fotos completa, detalhes da loja e simular o financiamento deste <strong>{v.brand} {v.model} {v.version}</strong>, por favor, crie uma conta ou faça login. </p> <div className="flex flex-col sm:flex-row gap-4 justify-center"> <a href="#/login" className="rounded-2xl bg-red-600 text-white px-5 py-3 font-semibold shadow-sm hover:bg-red-700 w-full sm:w-auto"> Fazer Login </a> <a href="#/register" className="rounded-2xl bg-gray-800 text-white ring-1 ring-gray-700 hover:bg-gray-700 px-5 py-3 font-semibold shadow-sm w-full sm:w-auto"> Criar Conta (Grátis) </a> </div> </div> </main> );
            }
            function LoginPage({ db }) {
              const [email, setEmail] = useState("");
              const [password, setPassword] = useState("");
              const [error, setError] = useState("");
              const [loading, setLoading] = useState(false);

              const handleLogin = async (e) => {
                e.preventDefault(); setError(""); setLoading(true);
                try { await firebase.auth().signInWithEmailAndPassword(email, password); } catch (err) {
                  if (err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password' || err.code === 'auth/invalid-credential') { setError("E-mail ou senha inválidos."); } else { setError("Falha no login. Tente novamente."); }
                  console.error("Erro de login:", err); setLoading(false);
                }
              };
              useEffect(() => { document.title = `Login — WSA Seminovos`; window.scrollTo(0, 0); }, []);
              return ( <main className="mx-auto max-w-sm px-3 py-10"> <div className="rounded-2xl ring-1 ring-gray-800 bg-gray-900 p-8"> <h1 className="text-2xl font-extrabold mb-6 text-white text-center">Login</h1> {error && <p className="text-red-400 bg-red-950 p-3 rounded-lg mb-4 text-sm">{error}</p>} <form onSubmit={handleLogin} className="grid gap-4"> <Field label="E-mail"><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="input-admin" required /></Field> <Field label="Senha"><input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="input-admin" required /></Field> <Button type="submit" className="bg-red-600 text-white hover:bg-red-700 w-full" disabled={loading}> {loading ? "Entrando..." : "Entrar"} </Button> </form> <p className="text-sm text-gray-400 mt-6 text-center">Não tem uma conta? <a href="#/register" className="text-red-500 hover:underline">Cadastre-se</a></p> <p className="text-sm text-gray-400 mt-4 text-center"><a href="#/forgot-password" className="text-red-500 hover:underline">Esqueceu a senha?</a></p> </div> </main> );
            }
            function RegisterPage({ db }) {
              const [email, setEmail] = useState("");
              const [password, setPassword] = useState("");
              const [error, setError] = useState("");
              const [loading, setLoading] = useState(false);

              const ensureUserProfile = async (userAuth) => {
                  if (!userAuth || !db) return;
                  const userRef = db.collection('users').doc(userAuth.uid);
                  try { const doc = await userRef.get(); if (!doc.exists) { console.log(`Perfil não encontrado, criando...`); await userRef.set({ email: userAuth.email, role: 'client', createdAt: firebase.firestore.FieldValue.serverTimestamp() }); console.log(`Perfil criado.`); } else { console.log(`Perfil já existe.`); } } catch (firestoreError) { console.error("Erro ao garantir perfil:", firestoreError); }
              };
              const handleRegister = async (e) => {
                e.preventDefault(); setError(""); setLoading(true); let userCredential = null;
                try { userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password); await ensureUserProfile(userCredential.user); } catch (err) {
                    let errorMessage = "Falha no cadastro. Verifique os dados.";
                    if (err.code === 'auth/email-already-in-use') {
                        errorMessage = "Este e-mail já está em uso. Tentando garantir perfil/logar...";
                        try { const signInCredential = await firebase.auth().signInWithEmailAndPassword(email, password); await ensureUserProfile(signInCredential.user); errorMessage = "E-mail já cadastrado. Fizemos login para você."; } catch (signInErr) { errorMessage = "Este e-mail já está cadastrado. Tente fazer login manualmente ou recuperar a senha."; }
                    } else if (err.code === 'auth/weak-password') { errorMessage = "Senha muito fraca. Use pelo menos 6 caracteres."; } else { console.error("Erro de cadastro:", err); }
                    setError(errorMessage); setLoading(false);
                }
              };
              useEffect(() => { document.title = `Cadastro — WSA Seminovos`; window.scrollTo(0, 0); }, []);
              return ( <main className="mx-auto max-w-sm px-3 py-10"> <div className="rounded-2xl ring-1 ring-gray-800 bg-gray-900 p-8"> <h1 className="text-2xl font-extrabold mb-6 text-white text-center">Criar Conta</h1> {error && <p className="text-red-400 bg-red-950 p-3 rounded-lg mb-4 text-sm">{error}</p>} <form onSubmit={handleRegister} className="grid gap-4"> <Field label="E-mail"><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="input-admin" required /></Field> <Field label="Senha (mínimo 6 caracteres)"><input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="input-admin" required minLength="6"/></Field> <Button type="submit" className="bg-red-600 text-white hover:bg-red-700 w-full" disabled={loading}> {loading ? "Criando..." : "Criar Conta"} </Button> </form> <p className="text-sm text-gray-400 mt-6 text-center">Já tem uma conta? <a href="#/login" className="text-red-500 hover:underline">Faça login</a></p> </div> </main> );
            }
            function ForgotPasswordPage() {
                const [email, setEmail] = useState(""); const [error, setError] = useState(""); const [success, setSuccess] = useState(""); const [loading, setLoading] = useState(false);
                const handlePasswordReset = async (e) => {
                    e.preventDefault(); setError(""); setSuccess(""); setLoading(true);
                    try { await firebase.auth().sendPasswordResetEmail(email); setSuccess("Verifique seu e-mail! Enviamos um link para você redefinir sua senha."); } catch (err) { console.error("Erro ao redefinir senha:", err); if (err.code === 'auth/user-not-found') { setError("Não encontramos uma conta com este e-mail."); } else { setError("Ocorreu um erro. Tente novamente."); } }
                    setLoading(false);
                };
                useEffect(() => { document.title = `Recuperar Senha — WSA Seminovos`; window.scrollTo(0, 0); }, []);
                return ( <main className="mx-auto max-w-sm px-3 py-10"> <div className="rounded-2xl ring-1 ring-gray-800 bg-gray-900 p-8"> <h1 className="text-2xl font-extrabold mb-4 text-white text-center">Recuperar Senha</h1> <p className="text-sm text-gray-400 mb-6 text-center">Digite seu e-mail e enviaremos um link para redefinição.</p> {error && <p className="text-red-400 bg-red-950 p-3 rounded-lg mb-4 text-sm">{error}</p>} {success && <p className="text-green-400 bg-green-950 p-3 rounded-lg mb-4 text-sm">{success}</p>} {!success && ( <form onSubmit={handlePasswordReset} className="grid gap-4"> <Field label="E-mail"><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="input-admin" required /></Field> <Button type="submit" className="bg-red-600 text-white hover:bg-red-700 w-full" disabled={loading}> {loading ? "Enviando..." : "Enviar Link de Recuperação"} </Button> </form> )} <p className="text-sm text-gray-400 mt-6 text-center">Lembrou a senha? <a href="#/login" className="text-red-500 hover:underline">Fazer login</a></p> </div> </main> );
            }
            function Detail({ slug, vehicles, user }) {
              const v = vehicles.find((x) => x.slug === slug);
              useEffect(() => { document.title = v ? `${v.brand} ${v.model} ${v.version} ${v.yearModel} — WSA Seminovos` : "Veículo — WSA Seminovos"; window.scrollTo(0, 0); }, [v]);
              if (user && user.profile && user.profile.role === 'visitor') { const vehicleData = vehicles.find((x) => x.slug === slug); return <LoginPrompt slug={slug} v={vehicleData} />; }
              if (!v) return <main className="mx-auto max-w-7xl px-3 py-12 text-gray-400">{vehicles.length > 0 ? 'Veículo não encontrado.' : 'Carregando veículo...'}</main>;
              const breadcrumb = [ { name: "Home", href: "#/" }, { name: "Estoque", href: "#/estoque" }, { name: `${v.brand} ${v.model}`, href: `#` }, ];
              return ( <main className="mx-auto max-w-7xl px-3 py-8"> <script type="application/ld+json" dangerouslySetInnerHTML={{ __html: JSON.stringify({ "@context": "https://schema.org", "@type": "Product", name: `${v.brand} ${v.model} ${v.version}`, brand: v.brand, model: v.model, color: v.color, vehicleTransmission: v.transmission, vehicleEngine: v.engine, vehicleSeatingCapacity: v.doors, bodyType: v.body, mileageFromOdometer: { "@type": "QuantitativeValue", value: v.km, unitCode: "KM" }, offers: { "@type": "Offer", priceCurrency: "BRL", price: v.price, availability: "https://schema.org/InStock" }, image: v.photos?.[0] || undefined, }) }} /> <nav className="text-sm text-gray-400 mb-4"> {breadcrumb.map((b, i) => ( <span key={b.name}> <a className="hover:text-red-500" href={b.href}>{b.name}</a> {i < breadcrumb.length - 1 && <span className="mx-2">/</span>} </span> ))} </nav> <div className="grid lg:grid-cols-[1fr_400px] gap-6"> <Gallery photos={v.photos || []} /> <aside className="grid gap-4 self-start"> <div className="p-4 rounded-2xl ring-1 ring-gray-800 bg-gray-900 grid gap-3"> <div className="flex items-center justify-between"> <div> <div className="text-xs text-gray-500">{v.brand}</div> <h1 className="text-2xl font-extrabold leading-tight text-white">{v.model} {v.version}</h1> </div> <Badge className="bg-red-950 text-red-300 ring-1 ring-red-800">{v.yearFab}/{v.yearModel}</Badge> </div> <div className="text-sm text-gray-400">{km(v.km)} · {v.transmission} · {v.fuel}</div> <div className="flex items-end gap-2"> {v.priceBase > v.price && <div className="text-sm text-gray-500 line-through">{real(v.priceBase)}</div>} <div className="text-3xl font-extrabold text-white">{real(v.price)}</div> </div> <div className="grid grid-cols-2 gap-2"> <Button className="bg-red-600 text-white hover:bg-red-700">Tenho interesse</Button> <Button className="bg-gray-800 text-white hover:bg-gray-700">Agendar visita</Button> </div> {v.tags?.includes("Mais pesquisado") && <div className="text-xs text-yellow-400">Muitas pessoas estão pesquisando por esse carro.</div>} </div> <FinanceSimulator price={v.price} /> <StoreInfo v={v} /> </aside> </div> <section className="mt-8 grid gap-6"> <div> <h2 className="text-lg font-bold mb-2 text-white">Sobre este carro</h2> <Specs v={v} /> </div> <div> <h2 className="text-lg font-bold mb-2 text-white">Acessórios e outros</h2> <Accessories /> </div> <div className="grid md:grid-cols-2 gap-6"> <div className="p-4 rounded-2xl ring-1 ring-gray-800 bg-gray-900"> <div className="font-semibold mb-1 text-white">Certificado de qualidade</div> <ul className="text-sm text-gray-300 list-disc pl-5"> <li>Garantia de procedência</li> <li>Documentação em dia</li> <li>Quilometragem confiável</li> <li>Inspeção de 360 itens</li> </ul> </div> <div className="p-4 rounded-2xl ring-1 ring-gray-800 bg-gray-900"> <div className="font-semibold mb-2 text-white">Seu usado vale mais na troca</div> <p className="text-sm text-gray-300">Avalie seu carro usado conosco e use na entrada. Fale com nosso time de vendas para começar.</p> <div className="mt-2"><Button className="bg-gray-800 text-white hover:bg-gray-700">Avaliar meu carro</Button></div> </div> </div> </section> <Recommend currentId={v.id} vehicles={vehicles} /> </main> );
            }
            function SimplePage({ title, children }) {
              useEffect(() => { document.title = `${title} — WSA Seminovos`; window.scrollTo(0, 0); }, [title]);
              return ( <main className="mx-auto max-w-4xl px-3 py-10"> <h1 className="text-2xl font-extrabold mb-4 text-white">{title}</h1> <div className="prose prose-invert max-w-none text-gray-300"> {children} </div> </main> );
            }

            // =============================
            // *** COMPONENTES DA ÁREA ADMINISTRATIVA ***
            // =============================
            function AdminLayout({ children }) {
                return ( <main className="mx-auto max-w-7xl px-3 py-8"> <h1 className="text-3xl font-extrabold text-white mb-6">Área Administrativa</h1> <div className="bg-gray-900 ring-1 ring-gray-800 rounded-2xl p-6"> {children} </div> </main> );
            }
            function ImageUploader({ initialImages = [], onUploadComplete, maxFiles = 10, storage }) {
                const [files, setFiles] = useState([]);
                const [previews, setPreviews] = useState(initialImages);
                const [uploading, setUploading] = useState(false);
                const [progress, setProgress] = useState({});
                const fileInputRef = useRef(null);
                useEffect(() => { setPreviews(initialImages); }, [initialImages]);
                const handleFileChange = (event) => {
                    const selectedFiles = Array.from(event.target.files);
                    if (previews.length + selectedFiles.length > maxFiles) { alert(`Você pode selecionar no máximo ${maxFiles} fotos no total.`); return; }
                    setFiles(prevFiles => [...prevFiles, ...selectedFiles]);
                    selectedFiles.forEach(file => { const reader = new FileReader(); reader.onloadend = () => { setPreviews(prev => [...prev, reader.result]); }; reader.readAsDataURL(file); });
                    if (fileInputRef.current) { fileInputRef.current.value = ""; }
                };
                const removePreview = (indexToRemove) => {
                   const urlToRemove = previews[indexToRemove];
                   const isExistingUrl = urlToRemove.startsWith('http');
                   const remainingPreviews = previews.filter((_, index) => index !== indexToRemove);
                   setPreviews(remainingPreviews);
                   if (!isExistingUrl) {
                     const filesStartIndex = initialImages.length;
                     const fileIndexToRemove = indexToRemove - filesStartIndex;
                     if (fileIndexToRemove >= 0 && fileIndexToRemove < files.length) { setFiles(prev => prev.filter((_, index) => index !== fileIndexToRemove)); console.log("Arquivo removido da lista de upload."); }
                   } else { console.log("Removendo URL existente:", urlToRemove); }
                   onUploadComplete(remainingPreviews);
                };
                const handleUpload = async () => {
                   if (files.length === 0) { onUploadComplete(previews.filter(p => p.startsWith('http'))); return; }
                   if (!storage) { alert("Erro: Serviço de Storage não inicializado."); return; }
                   setUploading(true); setProgress({});
                   const uploadPromises = files.map(file => {
                       return new Promise((resolve, reject) => {
                           const storageRef = storage.ref();
                           const fileRef = storageRef.child(`vehicle_images/${Date.now()}_${file.name.replace(/\s+/g, '_')}`);
                           const uploadTask = fileRef.put(file);
                           uploadTask.on('state_changed',
                               (snapshot) => { const percentage = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100); setProgress(prev => ({ ...prev, [file.name]: percentage })); },
                               (error) => { console.error("Erro no upload:", file.name, error); reject({fileName: file.name, error}); },
                               async () => { try { const downloadURL = await uploadTask.snapshot.ref.getDownloadURL(); resolve(downloadURL); } catch (getUrlError) { console.error("Erro ao obter URL:", file.name, getUrlError); reject({fileName: file.name, error: getUrlError}); } }
                           );
                       });
                   });
                   try {
                       const downloadURLs = await Promise.all(uploadPromises);
                       const existingHttpUrls = previews.filter(p => p.startsWith('http') && !p.startsWith('data:'));
                       const finalURLs = [...existingHttpUrls, ...downloadURLs];
                       console.log("Upload completo, URLs finais:", finalURLs);
                       onUploadComplete(finalURLs);
                       setFiles([]);
                       setPreviews(finalURLs);
                   } catch (errorInfo) { console.error("Falha no upload:", errorInfo); alert(`Erro ao fazer upload da imagem "${errorInfo.fileName}". Verifique o console e as regras de segurança.`);
                   } finally { setUploading(false); }
                };
                return (
                    <div>
                        <Field label={`Fotos (${previews.length}/${maxFiles})`}>
                            <input type="file" multiple accept="image/*" onChange={handleFileChange} ref={fileInputRef} className="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-red-600 file:text-white hover:file:bg-red-700 disabled:opacity-50" disabled={uploading || previews.length >= maxFiles} />
                        </Field>
                        {previews.length > 0 && (
                            <div className="mt-4 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3">
                                {previews.map((previewUrl, index) => (
                                    <div key={index} className="relative group aspect-video rounded-lg overflow-hidden ring-1 ring-gray-700 bg-gray-800">
                                        <img src={previewUrl} alt={`Preview ${index + 1}`} className="w-full h-full object-cover" onError={(e) => { e.target.src = 'https://placehold.co/160x90/222/FFF?text=Erro'; e.target.alt = 'Erro ao carregar'; }} />
                                        <button type="button" onClick={() => removePreview(index)} className="absolute top-1 right-1 bg-black/60 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600 disabled:opacity-50 disabled:cursor-not-allowed" disabled={uploading} aria-label="Remover imagem"> <Icon name="x" className="w-3 h-3" /> </button>
                                        {uploading && files.length > 0 && !previewUrl.startsWith('http') && (
                                            <div className="absolute inset-0 bg-black/70 flex items-center justify-center text-xs font-bold text-white">
                                                {progress[files[index - (previews.length - files.length)]?.name] ?? '...'}%
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}
                         {files.length > 0 && ( <Button type="button" onClick={handleUpload} className="mt-4 bg-blue-600 text-white hover:bg-blue-700" disabled={uploading}> {uploading ? 'Enviando Fotos...' : `Confirmar Upload (${files.length} novas)`} </Button> )}
                         {files.length === 0 && previews.length < maxFiles && ( <p className="text-xs text-gray-500 mt-2">Nenhuma nova foto selecionada. Clique acima para escolher ou clique em "Salvar" para confirmar remoções ou outros dados.</p> )}
                         {previews.length >= maxFiles && ( <p className="text-xs text-yellow-500 mt-2">Limite de {maxFiles} fotos atingido.</p> )}
                    </div>
                );
            }
            function CarForm({ db, appId, vehicleId, onSave, storage }) {
                const [vehicle, setVehicle] = useState({ brand: '', model: '', version: '', yearFab: '', yearModel: '', fuel: 'Flex', transmission: 'Manual', engine: '', body: 'Hatch', color: '', plateFinal: '', doors: 4, km: '', priceBase: '', price: '', tags: [], photos: [], store: { name: '', phone: '', address: '', hours: [{d: 'Segunda à sexta', h: ''}, {d: 'Sábado', h: ''}, {d: 'Domingo', h: ''}] } });
                const [loading, setLoading] = useState(false);
                const [error, setError] = useState('');
                const [isEditMode, setIsEditMode] = useState(!!vehicleId);
                const [uploadedPhotoUrls, setUploadedPhotoUrls] = useState([]);
                useEffect(() => {
                    const loadVehicle = () => {
                        setLoading(true); setError('');
                        const docRef = db.collection(`/artifacts/${appId}/public/data/vehicles`).doc(vehicleId);
                        docRef.get().then(doc => {
                            if (doc.exists) {
                                const data = doc.data();
                                setVehicle({ ...data, yearFab: data.yearFab || '', yearModel: data.yearModel || '', km: data.km || '', price: data.price || '', priceBase: data.priceBase || '', doors: data.doors || 4, tags: data.tags || [], photos: data.photos || [], store: { name: data.store?.name || '', phone: data.store?.phone || '', address: data.store?.address || '', hours: [ {...(data.store?.hours?.[0] || {d:'Segunda à sexta', h:''})}, {...(data.store?.hours?.[1] || {d:'Sábado', h:''})}, {...(data.store?.hours?.[2] || {d:'Domingo', h:''})} ] } });
                                setUploadedPhotoUrls(data.photos || []);
                            } else { setError('Veículo não encontrado.'); window.location.hash = '#/admin'; }
                            setLoading(false);
                        }).catch(err => { console.error("Erro ao buscar veículo:", err); setError('Erro ao carregar dados do veículo.'); setLoading(false); });
                    };
                    if (isEditMode) { loadVehicle();
                    } else {
                         setVehicle({ brand: '', model: '', version: '', yearFab: '', yearModel: '', fuel: 'Flex', transmission: 'Manual', engine: '', body: 'Hatch', color: '', plateFinal: '', doors: 4, km: '', priceBase: '', price: '', tags: [], photos: [], store: { name: '', phone: '', address: '', hours: [{d: 'Segunda à sexta', h: ''}, {d: 'Sábado', h: ''}, {d: 'Domingo', h: ''}] } });
                         setUploadedPhotoUrls([]); setLoading(false);
                    }
                    setError('');
                }, [db, appId, vehicleId, isEditMode]);
                const handleChange = (e) => { const { name, value, type } = e.target; const val = (type === 'number' && value === '') ? '' : (type === 'number' ? Number(value) : value); setVehicle(prev => ({ ...prev, [name]: val })); };
                const handleNestedChange = (parent, name, value) => { setVehicle(prev => ({ ...prev, [parent]: { ...prev[parent], [name]: value } })); };
                const handleTagChange = (e) => { setVehicle(prev => ({ ...prev, tags: e.target.value.split(',').map(tag => tag.trim()).filter(Boolean) })); };
                 const handleStoreHoursChange = (index, field, value) => {
                     setVehicle(prev => {
                         const newHours = [...(prev.store.hours || [])];
                         while (newHours.length <= index) { newHours.push({d:'', h:''}); }
                         newHours[index][field] = value;
                         return { ...prev, store: { ...prev.store, hours: newHours } };
                     });
                 };
                const handlePhotoUploadComplete = (urls) => { console.log("Formulário recebeu URLs finais:", urls); setUploadedPhotoUrls(urls); setVehicle(prev => ({...prev, photos: urls})); };
                const handleSubmit = async (e) => {
                    e.preventDefault();
                    if (!storage) { setError("Erro: Serviço de Storage não inicializado."); return; }
                    setLoading(true); setError('');
                    try {
                        const newId = Date.now();
                        const dataToSave = {
                            ...vehicle,
                            yearFab: vehicle.yearFab === '' ? null : Number(vehicle.yearFab),
                            yearModel: vehicle.yearModel === '' ? null : Number(vehicle.yearModel),
                            doors: vehicle.doors === '' ? null : Number(vehicle.doors),
                            km: vehicle.km === '' ? null : Number(vehicle.km),
                            priceBase: vehicle.priceBase === '' ? null : Number(vehicle.priceBase),
                            price: vehicle.price === '' ? null : Number(vehicle.price),
                            photos: uploadedPhotoUrls,
                            id: isEditMode ? vehicle.id : newId,
                            store: { name: vehicle.store?.name || '', phone: vehicle.store?.phone || '', address: vehicle.store?.address || '', hours: vehicle.store?.hours?.filter(h => h.d || h.h) || [] },
                             tags: vehicle.tags || []
                        };
                         dataToSave.slug = generateSlug(dataToSave);
                         if (!dataToSave.brand || !dataToSave.model || !dataToSave.version || !dataToSave.price || !dataToSave.km) { throw new Error("Campos obrigatórios (Marca, Modelo, Versão, Preço, KM) não podem estar vazios."); }
                         const collectionPath = `/artifacts/${appId}/public/data/vehicles`;
                         const docId = isEditMode ? vehicleId : dataToSave.id.toString();
                         const docRef = db.collection(collectionPath).doc(docId);
                         if (isEditMode) { await docRef.update(dataToSave); console.log("Veículo atualizado:", docId); } else { await docRef.set(dataToSave); console.log("Veículo adicionado:", docId); }
                         onSave();
                    } catch (err) { console.error("Erro ao salvar:", err); setError(`Erro ao salvar: ${err.message}.`); setLoading(false); }
                };
                if (loading && isEditMode && !vehicle.brand) { return <AdminLayout><LoadingScreen message="Carregando veículo..." /></AdminLayout>; }
                return (
                    <AdminLayout>
                        <h2 className="text-xl font-bold text-white mb-4">{isEditMode ? 'Editar Veículo' : 'Adicionar Novo Veículo'}</h2>
                        {error && <p className="text-red-400 bg-red-950 p-3 rounded-lg mb-4 text-sm">{error}</p>}
                        <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <Field label="Marca"><input type="text" name="brand" value={vehicle.brand || ''} onChange={handleChange} required className="input-admin" /></Field>
                            <Field label="Modelo"><input type="text" name="model" value={vehicle.model || ''} onChange={handleChange} required className="input-admin" /></Field>
                            <Field label="Versão"><input type="text" name="version" value={vehicle.version || ''} onChange={handleChange} required className="input-admin" /></Field>
                            <Field label="Ano Fabricação"><input type="number" name="yearFab" value={vehicle.yearFab || ''} onChange={handleChange} required className="input-admin" /></Field>
                            <Field label="Ano Modelo"><input type="number" name="yearModel" value={vehicle.yearModel || ''} onChange={handleChange} required className="input-admin" /></Field>
                            <Field label="Cor"><input type="text" name="color" value={vehicle.color || ''} onChange={handleChange} className="input-admin" /></Field>
                            <Field label="Combustível"><select name="fuel" value={vehicle.fuel || 'Flex'} onChange={handleChange} className="input-admin"><option value="Flex">Flex</option><option value="Gasolina">Gasolina</option><option value="Diesel">Diesel</option><option value="Elétrico">Elétrico</option><option value="Híbrido">Híbrido</option></select></Field>
                            <Field label="Câmbio"><select name="transmission" value={vehicle.transmission || 'Manual'} onChange={handleChange} className="input-admin"><option value="Manual">Manual</option><option value="Automático">Automático</option><option value="Automatizado">Automatizado</option><option value="CVT">CVT</option></select></Field>
                            <Field label="Motor"><input type="text" name="engine" value={vehicle.engine || ''} onChange={handleChange} placeholder="Ex: 1.0" className="input-admin" /></Field>
                            <Field label="Carroceria"><select name="body" value={vehicle.body || 'Hatch'} onChange={handleChange} className="input-admin"><option value="Hatch">Hatch</option><option value="Sedan">Sedan</option><option value="SUV">SUV</option><option value="Picape">Picape</option><option value="Van/Utilitário">Van/Utilitário</option><option value="Outro">Outro</option></select></Field>
                            <Field label="Portas"><input type="number" name="doors" value={vehicle.doors || ''} onChange={handleChange} className="input-admin" /></Field>
                            <Field label="Final da Placa"><input type="text" name="plateFinal" value={vehicle.plateFinal || ''} onChange={handleChange} maxLength="1" className="input-admin" /></Field>
                            <Field label="KM"><input type="number" name="km" value={vehicle.km || ''} onChange={handleChange} required className="input-admin" /></Field>
                            <Field label="Preço Base (Opcional)"><input type="number" name="priceBase" value={vehicle.priceBase || ''} onChange={handleChange} placeholder="Preço original" className="input-admin" /></Field>
                            <Field label="Preço de Venda"><input type="number" name="price" value={vehicle.price || ''} onChange={handleChange} required className="input-admin" /></Field>
                            <Field label="Tags (separadas por vírgula)"><input type="text" name="tags" value={(vehicle.tags || []).join(', ')} onChange={handleTagChange} placeholder="Ex: Mais pesquisado" className="input-admin" /></Field>
                            <Field label="Cidade"><input type="text" name="city" value={vehicle.city || ''} onChange={handleChange} required className="input-admin" /></Field>
                            <Field label="Estado (UF)"><input type="text" name="state" value={vehicle.state || ''} onChange={handleChange} maxLength="2" required className="input-admin" /></Field>
                            <div className="col-span-1 md:col-span-2 lg:grid-cols-3 grid grid-cols-1 md:grid-cols-2 gap-6 p-4 border border-gray-700 rounded-lg mt-4">
                                <h3 className="md:col-span-2 text-lg font-semibold text-white mb-2">Informações da Loja</h3>
                                <Field label="Nome da Loja"><input type="text" name="store.name" value={vehicle.store?.name || ''} onChange={e => handleNestedChange('store', 'name', e.target.value)} required className="input-admin" /></Field>
                                <Field label="Telefone da Loja"><input type="text" name="store.phone" value={vehicle.store?.phone || ''} onChange={e => handleNestedChange('store', 'phone', e.target.value)} className="input-admin" /></Field>
                                <Field label="Endereço Completo" className="md:col-span-2"><input type="text" name="store.address" value={vehicle.store?.address || ''} onChange={e => handleNestedChange('store', 'address', e.target.value)} required className="input-admin" /></Field>
                                {(vehicle.store?.hours || []).map((hour, index) => (
                                    <div key={index} className="grid grid-cols-2 gap-2">
                                        <Field label={`Dia ${index + 1}`}><input type="text" value={hour.d || ''} onChange={e => handleStoreHoursChange(index, 'd', e.target.value)} className="input-admin" /></Field>
                                        <Field label={`Horário ${index + 1}`}><input type="text" value={hour.h || ''} onChange={e => handleStoreHoursChange(index, 'h', e.target.value)} className="input-admin" placeholder="08:00 - 18:00"/></Field>
                                    </div>
                                ))}
                            </div>
                            <div className="col-span-1 md:col-span-2 lg:col-span-3 mt-4">
                               <ImageUploader initialImages={uploadedPhotoUrls} onUploadComplete={handlePhotoUploadComplete} storage={storage} />
                            </div>
                            <div className="col-span-1 md:col-span-2 lg:col-span-3 flex justify-end gap-4 mt-6">
                                <Button type="button" onClick={() => window.location.hash = '#/admin'} className="bg-gray-700 text-white hover:bg-gray-600" disabled={loading}> Cancelar </Button>
                                <Button type="submit" className="bg-red-600 text-white hover:bg-red-700" disabled={loading}> {loading ? 'Salvando...' : (isEditMode ? 'Salvar Alterações' : 'Adicionar Veículo')} </Button>
                            </div>
                        </form>
                    </AdminLayout>
                );
            }
            function AdminDashboard({ db, appId, vehicles }) {
                const [loading, setLoading] = useState(false);
                const [error, setError] = useState('');
                const handleDelete = async (vehicleId, vehicleName) => {
                    if (!confirm(`Tem certeza que deseja excluir o veículo "${vehicleName}" (${vehicleId})? Esta ação não pode ser desfeita.`)) { return; }
                    setLoading(true); setError('');
                    try { const docRef = db.collection(`/artifacts/${appId}/public/data/vehicles`).doc(vehicleId.toString()); await docRef.delete(); console.log("Veículo excluído:", vehicleId); } catch (err) { console.error("Erro ao excluir:", err); setError('Erro ao excluir veículo.'); } finally { setLoading(false); }
                };
                return (
                    <AdminLayout>
                        <div className="flex justify-between items-center mb-6"> <h2 className="text-xl font-bold text-white">Gerenciar Estoque ({vehicles.length})</h2> <a href="#/admin/add"> <Button className="bg-red-600 text-white hover:bg-red-700">Adicionar Novo Veículo</Button> </a> </div>
                        {error && <p className="text-red-400 bg-red-950 p-3 rounded-lg mb-4 text-sm">{error}</p>}
                        <div className="overflow-x-auto">
                           <table className="min-w-full divide-y divide-gray-700">
                                <thead className="bg-gray-800">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ID</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Veículo</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Ano</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Preço</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">KM</th>
                                        <th className="relative px-6 py-3"><span className="sr-only">Ações</span></th>
                                    </tr>
                                </thead>
                                <tbody className="bg-gray-900 divide-y divide-gray-700">
                                    {vehicles.length === 0 && !loading && ( <tr><td colSpan="6" className="px-6 py-4 whitespace-nowrap text-sm text-gray-400 text-center">Nenhum veículo cadastrado.</td></tr> )}
                                    {[...vehicles].sort((a, b) => (b.id || 0) - (a.id || 0)).map((v) => (
                                        <tr key={v.id} className="hover:bg-gray-800">
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-400">{v.id}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">{v.brand} {v.model} {v.version}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-400">{v.yearFab}/{v.yearModel}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-white">{real(v.price)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-400">{km(v.km)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                                <a href={`#/admin/edit/${v.id}`} className="text-blue-400 hover:text-blue-300">Editar</a>
                                                <button onClick={() => handleDelete(v.id, `${v.brand} ${v.model}`)} className="text-red-500 hover:text-red-400 disabled:opacity-50" disabled={loading}> Excluir </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                         {loading && <p className="text-center mt-4 text-gray-400">Processando...</p>}
                    </AdminLayout>
                );
            }

            // =============================
            // ROTEAMENTO SIMPLES (#/...)
            // =============================
            function useHashRoute() {
              const [hash, setHash] = useState(window.location.hash || "#/");
              useEffect(() => {
                const onChange = () => { setHash(window.location.hash || "#/"); window.scrollTo(0, 0); }
                window.addEventListener("hashchange", onChange);
                return () => window.removeEventListener("hashchange", onChange);
              }, []);
              return hash.replace(/^#/, "");
            }

            function Router({ vehicles, user, db, appId, storage }) {
              const route = useHashRoute();
              const isAdmin = user && user.profile && user.profile.role === 'admin';
              const isLoadingAuth = user === undefined; // Estado inicial de carregamento

              if (isLoadingAuth) {
                  return <LoadingScreen message="Autenticando..." />;
              }

              if (route.startsWith("/login")) return <LoginPage db={db} />;
              if (route.startsWith("/register")) return <RegisterPage db={db} />;
              if (route.startsWith("/forgot-password")) return <ForgotPasswordPage />;

              if (route.startsWith("/admin")) {
                  if (!isAdmin) {
                      console.warn("Acesso negado à área admin. Redirecionando...");
                      if (window.location.hash !== '#/login' && window.location.hash !== '#/') {
                         window.location.hash = user.auth ? "#/" : "#/login";
                      }
                      return <LoadingScreen message="Acesso negado. Redirecionando..."/>;
                  }
                  
                  if (route === "/admin") return <AdminDashboard db={db} appId={appId} vehicles={vehicles} />;
                  if (route === "/admin/add") return <CarForm db={db} appId={appId} storage={storage} onSave={() => window.location.hash = "#/admin"} />;
                  if (route.startsWith("/admin/edit/")) {
                      const vehicleId = route.split("/admin/edit/")[1];
                      return <CarForm db={db} appId={appId} storage={storage} vehicleId={vehicleId} onSave={() => window.location.hash = "#/admin"} />;
                  }
                   return <AdminLayout><h2>Página Admin não encontrada</h2></AdminLayout>;
              }

              if (route.startsWith("/carro/")) {
                const slug = route.split("/carro/")[1];
                return <Detail slug={slug} vehicles={vehicles} user={user} />;
              }
              if (route.startsWith("/estoque")) return <Catalog vehicles={vehicles} />;
              if (route.startsWith("/lojas")) return <SimplePage title="Nossas lojas">Em breve: lista de lojas por UF e cidade, com horários e agendamento.</SimplePage>;
              if (route.startsWith("/duvidas")) return <SimplePage title="Dúvidas">Em breve: perguntas frequentes sobre financiamento, troca com usado e garantia.</SimplePage>;
              if (route.startsWith("/vantagens")) return <SimplePage title="Vantagens e benefícios">Em breve: página institucional de benefícios e diferenciais.</SimplePage>;
              return <Home vehicles={vehicles} />;
            }

            // =============================
            // APP RAIZ
            // =============================
            function DealershipCatalogApp() {
              const [db, setDb] = useState(null);
              const [authInstance, setAuthInstance] = useState(null);
              const [storage, setStorage] = useState(null);
              const [appId, setAppId] = useState('default-app-id');
              const [vehicles, setVehicles] = useState([]);
              const [user, setUser] = useState(undefined); // undefined = inicial, null = anônimo, objeto = logado
              const [isLoadingData, setIsLoadingData] = useState(true);
              const [isLoadingAuth, setIsLoadingAuth] = useState(true);

              // 1. Inicializa o Firebase
              useEffect(() => {
                try {
                    const firebaseConfig = {
                      apiKey: "AIzaSyCkCIttysdLHMbEr4xfBoIHrMT6-khSrRk",
                      authDomain: "wsa-site-concessionaria.firebaseapp.com",
                      projectId: "wsa-site-concessionaria",
                      storageBucket: "wsa-site-concessionaria.appspot.com",
                      messagingSenderId: "860029979435",
                      appId: "1:860029979435:web:72fb9c7e622119e9f9936e",
                      measurementId: "G-N9KZGZ7PZB"
                    };
                    
                    const appIdValue = firebaseConfig.projectId; // Usa o Project ID como App ID

                    if (firebase.apps.length === 0) {
                        const app = firebase.initializeApp(firebaseConfig);
                        setAuthInstance(firebase.auth(app));
                        setDb(firebase.firestore(app));
                        setStorage(firebase.storage(app));
                        firebase.firestore.setLogLevel('debug');
                        setAppId(appIdValue);
                        console.log("Firebase Inicializado com appId:", appIdValue);
                    } else {
                        const app = firebase.apps[0];
                        setAuthInstance(firebase.auth(app));
                        setDb(firebase.firestore(app));
                        setStorage(firebase.storage(app));
                        setAppId(appIdValue);
                        console.log("Firebase Reutilizado com appId:", appIdValue);
                    }
                } catch (e) {
                    console.error("Erro CRÍTICO ao inicializar o Firebase. Verifique a configuração.", e);
                    setIsLoadingAuth(false);
                    setIsLoadingData(false);
                }
              }, []);

              // 2. Gerencia o estado de Autenticação (usuário logado)
              useEffect(() => {
                if (!authInstance || !db) {
                    if(isLoadingAuth) setIsLoadingAuth(false); 
                    return;
                }

                console.log("Iniciando listener de autenticação...");
                let userProfileUnsubscribe = null;

                const authUnsubscribe = authInstance.onAuthStateChanged(async (userAuth) => {
                    console.log("onAuthStateChanged disparado...");
                    // Não seta isLoadingAuth(true) aqui para evitar piscar tela
                    if (userProfileUnsubscribe) userProfileUnsubscribe();

                    if (userAuth) {
                        console.log("Usuário autenticado:", userAuth.uid, "Anônimo:", userAuth.isAnonymous);
                        if (userAuth.isAnonymous) {
                            setUser({ auth: userAuth, profile: { role: 'visitor' } });
                            setIsLoadingAuth(false);
                            console.log("Estado definido: Visitante anônimo");
                        } else {
                           console.log("Usuário não anônimo, buscando/criando perfil...");
                           const userRef = db.collection('users').doc(userAuth.uid);
                           let profileData = null;
                           let docExists = false;

                           try {
                               // Adiciona listener para perfil
                               userProfileUnsubscribe = userRef.onSnapshot(async (doc) => {
                                   if (doc.exists) {
                                       console.log("Perfil encontrado/atualizado via onSnapshot:", doc.data());
                                       setUser({ auth: userAuth, profile: doc.data() });
                                       setIsLoadingAuth(false); 
                                        if(window.location.hash.includes('/login') || window.location.hash.includes('/register') || window.location.hash.includes('/forgot-password')) {
                                           console.log("Redirecionando para Home...");
                                           window.location.hash = "#/";
                                       }
                                   } else {
                                       console.log("Perfil não encontrado via onSnapshot, tentando criar...");
                                       try {
                                           profileData = {
                                               email: userAuth.email,
                                               role: 'client',
                                               createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                           };
                                           await userRef.set(profileData);
                                           console.log("Perfil criado após não encontrar no snapshot.");
                                       } catch (creationError){
                                            console.error("Erro ao tentar criar perfil no snapshot:", creationError);
                                            setUser({ auth: userAuth, profile: { role: 'client', email: userAuth.email, firestoreError: true } });
                                            setIsLoadingAuth(false); 
                                       }
                                   }
                               }, (error) => { 
                                    console.error("Erro no listener onSnapshot do perfil:", error);
                                    setUser({ auth: userAuth, profile: { role: 'client', email: userAuth.email, firestoreError: true } });
                                    setIsLoadingAuth(false); 
                               });
                               
                           } catch (error) { 
                               console.error("Erro CRÍTICO ao adicionar listener do perfil:", error);
                               setUser({ auth: userAuth, profile: { role: 'client', email: userAuth.email, firestoreError: true } });
                               setIsLoadingAuth(false); 
                           }
                        }
                    } else {
                        console.log("Usuário não logado, tentando login anônimo...");
                        authInstance.signInAnonymously().catch(err => {
                            console.error("Erro no login anônimo:", err);
                            setUser({ auth: null, profile: { role: 'visitor' } }); 
                        }).finally(() => {
                           setIsLoadingAuth(false);
                           console.log("Estado definido: Visitante (anônimo ou falha)");
                        });
                    }
                });

                return () => {
                    console.log("Limpando listener de autenticação.");
                    authUnsubscribe();
                    if (userProfileUnsubscribe) {
                        console.log("Limpando listener do perfil.");
                        userProfileUnsubscribe();
                    }
                }
              }, [authInstance, db]);

              // 3. Busca os dados dos Veículos
              useEffect(() => {
                  if (!db || appId === 'default-app-id') { setIsLoadingData(false); return; }; 

                  const collectionPath = `/artifacts/${appId}/public/data/vehicles`;
                  console.log(`Iniciando listener de veículos em ${collectionPath}`);
                  const vehiclesCol = db.collection(collectionPath);

                  const unsubscribe = vehiclesCol.onSnapshot((snapshot) => {
                      const vehiclesData = snapshot.docs.map(doc => {
                          const data = doc.data();
                          return {
                              ...data,
                              id: Number(data.id) || null,
                              yearFab: Number(data.yearFab) || null,
                              yearModel: Number(data.yearModel) || null,
                              doors: Number(data.doors) || null,
                              km: Number(data.km) || 0,
                              price: Number(data.price) || 0,
                              priceBase: Number(data.priceBase) || Number(data.price) || 0,
                              tags: Array.isArray(data.tags) ? data.tags : [],
                              photos: Array.isArray(data.photos) ? data.photos : [],
                              store: { name: data.store?.name || '', phone: data.store?.phone || '', address: data.store?.address || '', hours: Array.isArray(data.store?.hours) ? data.store.hours : [] }
                          };
                      });
                      console.log(`Dados de veículos recebidos: ${vehiclesData.length}`);
                      setVehicles(vehiclesData);
                      setIsLoadingData(false);
                  }, (error) => {
                      console.error("Erro ao buscar veículos do Firestore: ", error);
                      if (error.code === 'permission-denied') {
                          console.error(`VERIFIQUE AS REGRAS (${error.code}) para: ${collectionPath}`);
                          alert("Erro: Permissão negada para ler veículos.");
                      } else {
                          alert("Erro ao carregar veículos.");
                      }
                      setIsLoadingData(false);
                  });

                  return () => {
                      console.log("Limpando listener de veículos.");
                      unsubscribe();
                  }
              }, [db, appId]);

              // 4. Função de UPLOAD (Seed)
              useEffect(() => {
                if (!db || !authInstance || appId === 'default-app-id') return;

                window.seedDatabase = async () => {
                    console.log("Iniciando o Seed do banco de dados...");
                    
                    const currentUser = authInstance.currentUser;
                    if (!currentUser || currentUser.isAnonymous) {
                         alert("Acesso negado. Você precisa estar logado com uma conta de administrador.");
                         console.error("Seed negado: usuário não logado ou anônimo.");
                         return;
                    }
                    
                    console.log("Verificando permissão de admin para:", currentUser.uid);
                    const userRef = db.collection('users').doc(currentUser.uid);
                    let userDoc;
                    try {
                        userDoc = await userRef.get();
                        if (!userDoc.exists || userDoc.data().role !== 'admin') {
                            alert("Acesso negado. Você não tem permissão de administrador para executar esta ação. (Verifique o Firestore)");
                            console.error("Seed negado: usuário não é admin ou perfil não encontrado.", userDoc.exists ? userDoc.data().role : 'Não existe');
                            return;
                        }
                    } catch (e) {
                         alert("Erro ao verificar permissão de admin. Verifique as Regras do Firestore e o console.");
                         console.error("Erro ao verificar admin:", e);
                         return;
                    }
                    
                    console.log("Usuário verificado como admin. Prosseguindo com o seed...");
                    const collectionPath = `/artifacts/${appId}/public/data/vehicles`;
                    const vehiclesCol = db.collection(collectionPath);
                    
                    let existingDataSize = 0;
                    try {
                        const existingData = await vehiclesCol.get();
                        existingDataSize = existingData.size;
                        console.log(`Coleção ${collectionPath} contém ${existingDataSize} documentos.`);
                    } catch (e) {
                         alert("Erro ao ler coleção de veículos. Verifique as regras do Firestore e o console.");
                         console.error("Erro ao ler veículos:", e);
                         return;
                    }
                    
                    if (existingDataSize > 0) {
                        if (!confirm(`A coleção ${collectionPath} já contém ${existingDataSize} documentos. Deseja APAGAR TODOS e recadastrar os ${MOCK_VEHICLES_FOR_SEEDING.length} veículos de exemplo?`)) {
                           console.log("Seed cancelado pelo usuário.");
                           return;
                        }
                        
                        console.log("Deletando dados antigos...");
                        const deleteBatch = db.batch();
                        const oldDocs = await vehiclesCol.limit(400).get(); 
                        if (oldDocs.size > 0) {
                           oldDocs.docs.forEach(doc => deleteBatch.delete(doc.ref));
                           await deleteBatch.commit();
                           console.log(`${oldDocs.size} documentos antigos deletados (ou o limite). Repita se necessário.`);
                           if(oldDocs.size >= 400) {
                               alert(`${oldDocs.size} documentos antigos deletados. Recarregue e execute novamente se havia mais.`);
                               return;
                           }
                        } else {
                             console.log("Nenhum documento antigo encontrado para deletar.");
                        }
                    }

                    console.log(`Iniciando upload em lote de ${MOCK_VEHICLES_FOR_SEEDING.length} veículos...`);
                    const batchSize = 400;
                    for (let i = 0; i < MOCK_VEHICLES_FOR_SEEDING.length; i += batchSize) {
                        const batch = db.batch();
                        const chunk = MOCK_VEHICLES_FOR_SEEDING.slice(i, i + batchSize);
                        console.log(`Processando lote ${i / batchSize + 1} com ${chunk.length} veículos...`);

                        chunk.forEach(vehicle => {
                            const docId = vehicle.id.toString(); 
                            const docRef = db.collection(collectionPath).doc(docId);
                            const cleanVehicle = Object.fromEntries(Object.entries(vehicle).filter(([_, v]) => v != null));
                            batch.set(docRef, cleanVehicle);
                        });

                        try {
                            await batch.commit();
                            console.log(`Lote ${i / batchSize + 1} enviado com sucesso.`);
                        } catch (e) {
                            console.error(`Erro ao enviar lote ${i / batchSize + 1}: `, e);
                            alert(`Ocorreu um erro ao fazer o upload do lote ${i / batchSize + 1}. Verifique o console e as regras do Firestore.`);
                            return;
                        }
                    }

                    console.log(`SUCESSO! ${MOCK_VEHICLES_FOR_SEEDING.length} veículos foram cadastrados.`);
                    alert(`Sucesso! ${MOCK_VEHICLES_FOR_SEEDING.length} veículos foram cadastrados.`);
                };
                console.log("Função de upload 'seedDatabase()' pronta. Digite no console para popular o banco (requer admin logado).");
                return () => { delete window.seedDatabase; console.log("Função seedDatabase removida."); }
              }, [db, authInstance, appId]);

              // 5. Função de Logout
              const handleSignOut = () => {
                if (authInstance) {
                    console.log("Deslogando usuário...");
                    authInstance.signOut();
                    window.location.hash = "#/";
                }
              };
              
              // 6. Efeito para Título Padrão
              useEffect(() => { document.title = "WSA Seminovos — Catálogo"; }, []);

              // 7. Função e Efeito para Busca no Header
              const handleSearch = (q) => {
                window.location.hash = "#/estoque";
                localStorage.setItem("wsa_query", q);
                window.dispatchEvent(new Event("wsa-search"));
              };

              useEffect(() => {
                const on = () => {
                  const input = document.querySelector("input[aria-label='Buscar no estoque']");
                  const q = localStorage.getItem("wsa_query") || "";
                  if (input) {
                    input.value = q;
                    input.dispatchEvent(new Event("input", { bubbles: true }));
                  }
                };
                window.addEventListener("wsa-search", on);
                return () => window.removeEventListener("wsa-search", on);
              }, []);

              // Tela de Loading Principal
              if (user === undefined || isLoadingData) { // undefined = auth não checou; isLoadingData = dados não chegaram
                 console.log(`Ainda carregando: Dados=${isLoadingData}, Auth=${user === undefined}`);
                 return <LoadingScreen />;
              }
               console.log("Renderizando App Completo. Usuário:", user?.profile?.role);

              // Renderização Principal
              return (
                <div className="min-h-screen grid grid-rows-[auto_1fr_auto] bg-black text-gray-200">
                  <TopBar/>
                  <Header onSearch={handleSearch} user={user} onSignOut={handleSignOut} />
                  {/* Passa storage para o Router */}
                  <Router vehicles={vehicles} user={user} db={db} appId={appId} storage={storage} />
                  <Footer/>
                </div>
              );
            }

            // =============================
            // INICIALIZAÇÃO DO REACT
            // =============================
            const container = document.getElementById('root');
            if (container) {
              try {
                const root = ReactDOM.createRoot(container);
                root.render(<DealershipCatalogApp />);
              } catch (e) {
                console.error("Erro ao renderizar o React:", e);
                container.innerHTML = `<div style="color: red; padding: 20px; text-align: center; font-family: sans-serif;"><h1>Erro ao carregar o aplicativo</h1><p>${e.message}</p></div>`;
              }
            } else {
              console.error("Erro fatal: <div id='root'> não encontrado.");
            }
        
        } // Fim da função main()
        
        // Garante que a função main só rode depois que todos os scripts (incluindo Firebase) carregaram
        window.onload = main;
    </script>
    
    {/* Estilos auxiliares para os inputs do admin */}
    <style>
        .input-admin {
             @apply rounded-lg border-gray-700 bg-gray-800 text-white w-full focus:ring-red-500 focus:border-red-500 disabled:opacity-50 placeholder-gray-500 px-3 py-2 text-sm;
        }
        select.input-admin {
             @apply pr-8;
        }
        input[type=range] {
             height: 4px;
             cursor: pointer;
             appearance: none;
             width: 100%;
             background: #4b5563; /* gray-600 */
             border-radius: 9999px;
             outline: none;
        }
        input[type=range]::-webkit-slider-thumb {
            appearance: none;
            height: 16px;
            width: 16px;
            background: #DC2626; /* red-600 */
            border-radius: 50%;
            cursor: pointer;
        }
         input[type=range]::-moz-range-thumb {
             height: 16px;
             width: 16px;
             background: #DC2626; /* red-600 */
             border-radius: 50%;
             cursor: pointer;
             border: none; /* Remove border padrão do Firefox */
         }
         input:invalid, select:invalid {
            @apply border-red-500 ring-red-500;
         }
    </style>
</body>
</html>
